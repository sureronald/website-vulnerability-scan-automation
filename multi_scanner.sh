#!/bin/sh
#Author: Ronald Osure (c) 2014
#Purpose: Scan websites and generate vulnerability reports in html/txt formats where applicable
#         Reads domain names from a line separated file
#----- DEPENDENCIES ------
#----- 1. Whatweb (Quick website footprinting)
#----- 2. Joomscan (Joomla Vulnerability Scanner)
#----- 3. DpScan (Drupal Vulnerability Scanner Scanner) ** No reliable Dpscan yet
#----- 4. WpScan (Wordpress Vulnerability Scanner)
#----- 5. Nikto Vulnerability scanner

WHATWEB_CMD="ruby /usr/bin/whatweb "
JOOMSCAN_CMD="perl /usr/share/joomscan/joomscan.pl "
JOOMSCAN_DIR="/usr/share/joomscan"
WPSCAN_CMD="ruby /opt/backbox/wpscan/wpscan.rb "
DPSCAN_CMD=""

REPORTS_DIR="CMS_Scan_Reports"

help(){
 echo "Usage: sh ./multiscanner.sh [filename]"
 echo "       Where filename is a line separated file containing domain names (FQDN)"
}

# Check root privileges
if [ $(id -u) -ne 0 ]; then
  echo '[!] Please run this script as root' >&2
  exit 1
fi

#Check for arguments count
if [ "$#" -eq  "1" ]; then
 if [ -e $1 ]; then
  echo #We just continue
 else
  help
  exit 1
 fi
else
 help
 exit 1
fi;

echo "Trying to create Reports Dir $REPORTS_DIR in $PWD"
if [ -d $REPORTS_DIR ]; then
 echo "[!] Dir exists.. carrying on"
else
 mkdir $REPORTS_DIR
fi

#We loop through each domain in the file
for domain in $(cat $1); do 
 #Check for empty lines. If line empty.. then continue
 #if [ "${#domain}" -eq "0" ]; then
 # continue
 #fi
 
 echo "[+] Doing footprinting <whatweb> on $domain"
 whatweb_recon=`$WHATWEB_CMD --no-errors -a 3 $domain`

 CMS_FOUND=0 #Default for true

 #Check if site is running the Joomla! CMS. Joomscan has a nice reporting feature that outputs HTML
 #We use this but at the end we copy the generated reports to our folder
 #Joomscan will save reports to its own reporting folder in $JOOMSCAN_DIR
 echo "$whatweb_recon" | grep -i "joomla" > /dev/null
 if [ $? -eq 0 ]; then
  echo "[+] Joomla! detected.. Starting Joomscan in a moment"
  CMS_FOUND=1
  cd $JOOMSCAN_DIR
  exec $JOOMSCAN_CMD -u $domain -oh
  cd $OLPWD 
 fi;

 #Check if site is running WordPress CMS. We only check if Joomla! above failed
 if [ "$CMS_FOUND" -ne "1" ]; then
  echo "$whatweb_recon" | grep -i "wordpress" > /dev/null
  if [ $? -eq 0 ]; then
   echo "[+] Wordpress detected.. Starting wpscan in a moment"
   CMS_FOUND=1
   exec $WPSCAN_CMD --url $domain --follow-redirection | tee $REPORTS_DIR/$domain-wordpress-scan.txt
  fi;
 fi;

 #Check if site is running Drupal CMS. Again we only check if all the above failed
 #I have not found a well maintained drupal scanner.

 #Last resort scanner - Nikto. Platform indepenedent scan
 if [ "$CMS_FOUND" -ne "1" ]; then
  echo "[+] Website CMS unknown.. Starting Nikto Scan in a moment"
  perl /usr/bin/nikto -host $domain | tee $REPORTS_DIR/$domain-nikto-scan.txt
 fi

 #RESET CMS TRACKING TO PREVENT DUPLICATE SCANNING 
 CMS_FOUND=0
done
 

#We now copy the Joomla scan reports to our Reports Dir
echo "[+] Copying Joomla scan reports to $REPORTS_DIR"
cp -r $JOOMSCAN_DIR/report $REPORTS_DIR

echo "------------ DONE ----------------"
echo "------------ Reports --> $REPORTS_DIR"
exit 0

